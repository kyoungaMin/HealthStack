  const handleAnalysis = async (query: string) => {
    if (!query.trim()) return;
    setLoading(true);
    setAnalysisResult(null);
    setBackendResult(null);
    setGroundingLinks([]);
    setRecommendedVideos([]);
    setShowResult(false);

    try {
      // 1. ë°±ì—”ë“œ API í˜¸ì¶œ (DB ê¸°ë°˜ ë¶„ì„)
      const backendRes = await fetch(`${BACKEND_URL}/api/analyze`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ symptom: query })
      });

      if (backendRes.ok) {
        const data: BackendResponse = await backendRes.json();
        setBackendResult(data);

        // YouTube ì˜ìƒ ì •ë³´ ì¶”ì¶œ
        const videos = data.ingredients
          .filter(ing => ing.youtube_video)
          .map(ing => ({
            title: ing.youtube_video!.title,
            uri: ing.youtube_video!.url
          }));
        setRecommendedVideos(videos);

        // PubMed ë…¼ë¬¸ ë§í¬ ì¶”ì¶œ
        const papers = data.ingredients
          .flatMap(ing => ing.pubmed_papers)
          .slice(0, 3)
          .map(p => ({ title: p.title, uri: p.url }));
        setGroundingLinks(papers);

        // DB ë§¤ì¹­ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì§ì ‘ í‘œì‹œ
        if (data.source !== 'ai_generated' && data.ingredients.length > 0) {
          const summary = `${data.symptom_summary}\n\nğŸŒ¿ **ë™ì˜ë³´ê° ì¶”ì²œ ì‹ì¬ë£Œ**\n${data.ingredients.map(ing =>
            `ğŸ‘‰ **${ing.modern_name}**: ${ing.rationale_ko}\n  ğŸ’¡ ${ing.tip}`
          ).join('\n\n')}\n\n${data.disclaimer}`;
          setAnalysisResult(summary);
          setShowResult(true);
          return;
        }
      }

      // 2. AI Fallback (DBì— ì—†ëŠ” ê²½ìš°)
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
      const response = await ai.models.generateContent({
        model: 'gemini-3-flash-preview',
        contents: `ì‚¬ìš©ìì˜ ì¦ìƒì´ë‚˜ ì§ˆë¬¸: "${query}". 
        ì´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ (1) í˜„ì¬ ìƒíƒœë¥¼ ì¹œì ˆí•˜ê²Œ ì„¤ëª…í•´ì£¼ê³  
        (2) í˜„ëŒ€ ì˜í•™ì  ì£¼ì˜ì‚¬í•­ê³¼ (3) ë™ì˜ë³´ê° ê¸°ë°˜ ë˜ëŠ” ë„ì›€ì´ ë˜ëŠ” êµ¬ì²´ì ì¸ ì‹ì¬ë£Œ 2-3ê°œë¥¼ ì¶”ì²œí•´ì¤˜. 
        ë§íˆ¬ëŠ” ì•„ì£¼ ë”°ëœ»í•œ ì´ì›ƒì§‘ ì•½ì‚¬ì²˜ëŸ¼ í•´ì¤˜. 
        ë‹µë³€ì€ 3~4ê°œì˜ ì„¹ì…˜ìœ¼ë¡œ ë‚˜ëˆ ì„œ ì‘ì„±í•´ì¤˜.`,
        config: {
          tools: [{ googleSearch: {} }]
        }
      });

      const text = response.text;
      setAnalysisResult(text);
      setShowResult(true);

      // Extract links from analysis
      const chunks = response.candidates?.[0]?.groundingMetadata?.groundingChunks;
      if (chunks) {
        const links = chunks
          .filter(c => c.web)
          .map(c => ({ title: c.web!.title, uri: c.web!.uri }));
        setGroundingLinks(links);
      }

    } catch (error) {
      console.error(error);
      setAnalysisResult("ğŸ™ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì— ì‘ì€ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”. ë‹¤ì‹œ í•œë²ˆ ë§ì”€í•´ ì£¼ì‹œê² ì–´ìš”?");
      setShowResult(true);
    } finally {
      setLoading(false);
    }
  };
