import React, { useState, useEffect, useRef } from 'react';
import { createRoot } from 'react-dom/client';
import { GoogleGenAI, Modality } from "@google/generative-ai";
import { decodeAudioData, decode } from "audio-decode";
import './index.css';

// --- Backend API Types ---
interface Ingredient {
  rep_code: string;
  modern_name: string;
  rationale_ko: string;
  direction: string;
  evidence_level: string;
  pubmed_papers: { pmid: string; title: string; journal: string; pub_year: number; url: string }[];
  youtube_video: { video_id: string; title: string; channel: string; thumbnail_url: string; url: string } | null;
  tip: string;
}

interface BackendResponse {
  symptom_summary: string;
  confidence_level: 'high' | 'medium' | 'general';
  source: 'database' | 'similarity' | 'ai_generated';
  ingredients: Ingredient[];
  cautions: string[];
  matched_symptom_name: string | null;
  disclaimer: string;
}

interface Medication {
  id: string;
  name: string;
  time: string; // "HH:MM" format
  taken: boolean;
}

const BACKEND_URL = 'http://localhost:8000';

// --- Golden Questions Data ---
const GOLDEN_QUESTIONS = [
  "ì‹í›„ ë”ë¶€ë£©í•˜ê³  íŠ¸ë¦¼ì´ ì¦ì•„. ì†Œí™”ì— ì¢‹ì€ ìŒì‹ì€?",
  "ì†ì“°ë¦¼ì´ ì‹¬í•œë° ë§¤ìš´ ê²ƒ ëŒ€ì‹  ë¨¹ì„ ë§Œí•œ ë ˆì‹œí”¼ëŠ”?",
  "ë³€ë¹„ê°€ ì‹¬í•´. ì»¤í”¼ ëŒ€ì‹  ë§ˆì‹¤ ìˆëŠ” ì°¨ ì¶”ì²œí•´ì¤˜.",
  "ëª¸ì´ ì°¨ê³  ì†ë°œì´ ìì£¼ ì €ë¦°ë° ë¨¹ìœ¼ë©´ ì¢‹ì€ ìŒì‹?",
  "ìŠ¤íŠ¸ë ˆìŠ¤ ë°›ìœ¼ë©´ ìê¾¸ í­ì‹í•˜ê²Œ ë¼. ì‹ìš• ì¡°ì ˆì— ë„ì›€ë˜ëŠ” ê²ƒ?",
  "ì˜¤í›„ë§Œ ë˜ë©´ í”¼ë¡œê°€ ë„ˆë¬´ ì‹¬í•´. ì¹´í˜ì¸ ë§ê³  ë„ì›€ë˜ëŠ” ê²ƒ?",
  "ê°ê¸° ê¸°ìš´ì´ ìˆì–´. ëª©ì´ ë”°ê°‘ê³  ì—´ì€ ì—†ëŠ”ë° ìŒì‹ ì¶”ì²œí•´ì¤˜.",
  "ë¹„ì—¼ì´ ì‹¬í•œë° ì½”ê°€ í¸í•´ì§€ëŠ” ìŒì‹ê³¼ ì¢‹ì€ ìŠµê´€ ì•Œë ¤ì¤˜.",
  "ê³ í˜ˆì••ì— ì¢‹ì€ ì‹ë‹¨ ì¶”ì²œì¢€.",
  "ë‹¤ì´ì–´íŠ¸ ì¤‘ì¸ë° ë°¤ì— ì•¼ì‹ ë•¡ê¸¸ ë•Œ ë¨¹ì–´ë„ ë˜ëŠ” ê°„ì‹ì€?",
  "í˜ˆë‹¹ ê´€ë¦¬ê°€ í•„ìš”í•œë° ë°¥ ë¨¹ì„ ë•Œ í˜ˆë‹¹ ëœ ì˜¤ë¥´ê²Œ í•˜ëŠ” ì¡°í•©ì€?"
];

// --- App Component ---

const App = () => {
  const [activeTab, setActiveTab] = useState<'home' | 'stack' | 'map' | 'report'>('home');
  const [loading, setLoading] = useState(false);
  const [analysisResult, setAnalysisResult] = useState<string | null>(null);
  const [backendResult, setBackendResult] = useState<BackendResponse | null>(null);
  const [groundingLinks, setGroundingLinks] = useState<{ title: string, uri: string }[]>([]);
  const [recommendedVideos, setRecommendedVideos] = useState<{ title: string, uri: string }[]>([]);
  const [userInput, setUserInput] = useState('');
  const [userLocation, setUserLocation] = useState<{ lat: number, lng: number } | null>(null);
  const [showResult, setShowResult] = useState(false);
  const [randomQuestions, setRandomQuestions] = useState<string[]>([]);
  
  // Medication States
  const [medications, setMedications] = useState<Medication[]>(() => {
    const saved = localStorage.getItem('medications');
    return saved ? JSON.parse(saved) : [];
  });
  const [newMedName, setNewMedName] = useState('');
  const [newMedTime, setNewMedTime] = useState('');
  const [notificationPermission, setNotificationPermission] = useState(Notification.permission);

  const audioContextRef = useRef<AudioContext | null>(null);

  useEffect(() => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((pos) => {
        setUserLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude });
      });
    }
    setRandomQuestions(GOLDEN_QUESTIONS.sort(() => 0.5 - Math.random()).slice(0, 4));
  }, []);

  // Save medications to local storage
  useEffect(() => {
    localStorage.setItem('medications', JSON.stringify(medications));
  }, [medications]);

  // Check for notifications every minute
  useEffect(() => {
    const interval = setInterval(() => {
      const now = new Date();
      const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
      
      medications.forEach(med => {
        if (med.time === currentTime && !med.taken) {
          if (Notification.permission === 'granted') {
            new Notification('ğŸ’Š ë³µìš© ì•Œë¦¼', {
              body: `${med.name} ë³µìš©í•  ì‹œê°„ì´ì—ìš”!`,
              icon: '/vite.svg'
            });
          }
        }
      });
    }, 60000); // Check every minute

    return () => clearInterval(interval);
  }, [medications]);

  const requestNotificationPermission = async () => {
    const permission = await Notification.requestPermission();
    setNotificationPermission(permission);
  };

  const addMedication = () => {
    if (!newMedName || !newMedTime) return;
    const newMed: Medication = {
      id: Date.now().toString(),
      name: newMedName,
      time: newMedTime,
      taken: false
    };
    setMedications([...medications, newMed]);
    setNewMedName('');
    setNewMedTime('');
  };

  const toggleMedication = (id: string) => {
    setMedications(medications.map(med => 
      med.id === id ? { ...med, taken: !med.taken } : med
    ));
  };

  const deleteMedication = (id: string) => {
    setMedications(medications.filter(med => med.id !== id));
  };

  const initAudio = () => {
    if (!audioContextRef.current) {
      audioContextRef.current = new (window.AudioContext || (window as any).webkitAudioContext)({ sampleRate: 24000 });
    }
  };

  const handleAnalysis = async (query: string) => {
    if (!query.trim()) return;
    setLoading(true);
    setAnalysisResult(null);
    setBackendResult(null);
    setGroundingLinks([]);
    setRecommendedVideos([]);
    setShowResult(false);

    try {
      const backendRes = await fetch(`${BACKEND_URL}/api/analyze`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ symptom: query })
      });

      if (backendRes.ok) {
        const data: BackendResponse = await backendRes.json();
        setBackendResult(data);

        const videos = data.ingredients
          .filter(ing => ing.youtube_video)
          .map(ing => ({
            title: ing.youtube_video!.title,
            uri: ing.youtube_video!.url
          }));
        setRecommendedVideos(videos);

        const papers = data.ingredients
          .flatMap(ing => ing.pubmed_papers)
          .slice(0, 3)
          .map(p => ({ title: p.title, uri: p.url }));
        setGroundingLinks(papers);

        if (data.source !== 'ai_generated' && data.ingredients.length > 0) {
          const summary = `${data.symptom_summary}\n\nğŸŒ¿ **ë™ì˜ë³´ê° ì¶”ì²œ ì‹ì¬ë£Œ**\n${data.ingredients.map(ing =>
            `ğŸ‘‰ **${ing.modern_name}**: ${ing.rationale_ko}\n  ğŸ’¡ ${ing.tip}`
          ).join('\n\n')}\n\n${data.disclaimer}`;
          setAnalysisResult(summary);
          setShowResult(true);
          return;
        }
      }

      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
      const response = await ai.models.generateContent({
        model: 'gemini-3-flash-preview',
        contents: `ì‚¬ìš©ìì˜ ì¦ìƒì´ë‚˜ ì§ˆë¬¸: "${query}". 
        ì´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ (1) í˜„ì¬ ìƒíƒœë¥¼ ì¹œì ˆí•˜ê²Œ ì„¤ëª…í•´ì£¼ê³  
        (2) í˜„ëŒ€ ì˜í•™ì  ì£¼ì˜ì‚¬í•­ê³¼ (3) ë™ì˜ë³´ê° ê¸°ë°˜ ë˜ëŠ” ë„ì›€ì´ ë˜ëŠ” êµ¬ì²´ì ì¸ ì‹ì¬ë£Œ 2-3ê°œë¥¼ ì¶”ì²œí•´ì¤˜. 
        ë§íˆ¬ëŠ” ì•„ì£¼ ë”°ëœ»í•œ ì´ì›ƒì§‘ ì•½ì‚¬ì²˜ëŸ¼ í•´ì¤˜. 
        ë‹µë³€ì€ 3~4ê°œì˜ ì„¹ì…˜ìœ¼ë¡œ ë‚˜ëˆ ì„œ ì‘ì„±í•´ì¤˜.`,
        config: {
          tools: [{ googleSearch: {} }]
        }
      });

      const text = response.text;
      setAnalysisResult(text);
      setShowResult(true);

      const chunks = response.candidates?.[0]?.groundingMetadata?.groundingChunks;
      if (chunks) {
        const links = chunks
          .filter(c => c.web)
          .map(c => ({ title: c.web!.title, uri: c.web!.uri }));
        setGroundingLinks(links);
      }

    } catch (error) {
      console.error(error);
      setAnalysisResult("ğŸ™ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì— ì‘ì€ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”. ë‹¤ì‹œ í•œë²ˆ ë§ì”€í•´ ì£¼ì‹œê² ì–´ìš”?");
      setShowResult(true);
    } finally {
      setLoading(false);
    }
  };

  const handleDemo = () => {
    setAnalysisResult(`ì•ˆë…•í•˜ì„¸ìš”! ì†ì´ ë”ë¶€ë£©í•˜ê³  ì–´ì§€ëŸ¬ìš°ì‹œêµ°ìš”. ë³µìš© ì¤‘ì¸ í˜ˆì••ì•½ ë•Œë¬¸ì¼ ê°€ëŠ¥ì„±ì´ ìˆì–´ ë³´ì—¬ìš”.

ğŸ’Š **í˜„ì¬ ìƒíƒœ ì´í•´**
í˜ˆì••ì•½ ì„±ë¶„ì´ ìœ„ì¥ì„ ìê·¹í•˜ë©´ ì¼ì‹œì ìœ¼ë¡œ ì†Œí™”ê¸°ëŠ¥ìœ¼ë¡œ ê°€ëŠ” í˜ˆë¥˜ì— ë³€í™”ë¥¼ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê±±ì •í•˜ì‹¤ ì •ë„ëŠ” ì•„ë‹ˆì§€ë§Œ ê°‘ìê¸° ì¼ì–´ì„œë©´ ë” ì–´ì§€ëŸ¬ìš¸ ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ì˜ê°€ í•„ìš”í•´ìš”.

âš ï¸ **ì£¼ì˜ì‚¬í•­**
ì‹ì‚¬ í›„ ë°”ë¡œ ëˆ•ì§€ ë§ˆì‹œê³  30ë¶„ ì •ë„ ê°€ë²¼ìš´ ì‚°ì±…ì„ ê¶Œí•´ë“œë ¤ìš”. ì–´ì§€ëŸ¬ì›€ì´ ì‹¬í•´ì§€ë©´ ì£¼ì¹˜ì˜ì™€ ìƒë‹´í•´ë³´ì‹œëŠ” ê²ƒì´ ì¢‹ê² ìŠµë‹ˆë‹¤.

ğŸŒ¿ **ë™ì˜ë³´ê° ìƒí™œ ê°€ì´ë“œ**
ë™ì˜ë³´ê°ì—ì„œëŠ” ì´ëŸ° ì¦ìƒì„ 'ë¬´'ì™€ 'ìƒê°•'ì„ ê¶Œì¥í•©ë‹ˆë‹¤. ë¬´ëŠ” ì²œì—° ì†Œí™”ì œ ì—­í• ì„ í•˜ê³ , ìƒê°•ì€ ì†ì˜ ëƒ‰ê¸°ë¥¼ ëª°ì•„ë‚´ê³  ìœ„ë¥¼ í¸ì•ˆí•˜ê²Œ í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.

ğŸ“ **ì¶”ì²œ ì„ íƒì§€**
ê·¼ì²˜ì— ì†Œí™”ê°€ í¸í•œ 'ì£½ ì „ë¬¸ì 'ì´ë‚˜ 'í•œì‹'ì„ ì§€ë„ì—ì„œ ì°¾ì•„ë³´ì‹œëŠ” ê±´ ì–´ë–¨ê¹Œìš”?`);
    setGroundingLinks([
      { title: "ì•½ë¬¼ ë¶€ì‘ìš© ì •ë³´ ì„¼í„°", uri: "#" },
      { title: "ë™ì˜ë³´ê° ì‹ì´ìš”ë²• ê°€ì´ë“œ", uri: "#" }
    ]);
    setRecommendedVideos([
      { title: "ì†ì´ í¸í•´ì§€ëŠ” ë¬´ë‚˜ë¬¼ ë§›ìˆê²Œ ë§Œë“œëŠ” ë²•", uri: "https://www.youtube.com/results?search_query=ë¬´ë‚˜ë¬¼ë ˆì‹œí”¼" },
      { title: "ëª¸ì„ ë”°ëœ»í•˜ê²Œ í•˜ëŠ” ìƒê°•ì°¨ ë§Œë“¤ê¸°", uri: "https://www.youtube.com/results?search_query=ìƒê°•ì°¨ë§Œë“¤ê¸°" }
    ]);
    setShowResult(true);
  };
