# 2026-02-06

## 요약
- ERD 문서 업데이트: 5개 신규 테이블(TKM/PubMed) 추가, 총 40→45개
- 마스터 테이블 스키마 확장: `foods_master`, `disease_master`에 현대명/영문명 컬럼 추가
- 시드 데이터 생성: 식재료 70+건, 질환 55+건 (동의보감→현대 용어 매핑)

---

## 프롬프트

### ERD 문서 업데이트
```
@[docs/erd/schema.integrated.dbml] 기반으로 docs/erd 문서 update 해줘
```

### 마스터 테이블 데이터 생성
```
@[docs/erd/schema.integrated.dbml] 마스터 테이블의 데이터를 만들어 줄수 있어?
```

### 문제 설명
```
traditional_foods table은 동의보감 raw data야. 이 테이블의 데이터를 추출해서 
foods_master, disease_master를 만들었는데, 현대 식재료 및 질병명과는 거리감이 있어.
```

### 실행 요청
```
마스터 테이블 확장하고 시드 데이터를 생성 해줄 수 있어?
```

---

## 작업내역

### [기능] ERD 문서 전체 업데이트
- `schema.integrated.dbml`에 추가된 5개 신규 테이블 반영
  - `tkm_symptom_master` - 동의보감 증상 마스터
  - `tkm_to_modern_map` - TKM→현대질환 매핑
  - `modern_to_mesh_map` - 현대질환→MeSH 매핑
  - `symptom_pubmed_map` - 증상 PubMed 검색 전략
  - `ingredient_pubmed_map` - 재료 PubMed 검색 전략
- 전체 ERD 문서 5개 파일 동기화
  - `readme.md`, `erd-integrated.md`, `erd-full.md`
  - `erd-content-rag-billing.md`, `erd-health-stack.md`
- 테이블 통계 40→45개로 업데이트

### [기능] 마스터 테이블 스키마 확장
- `foods_master` 컬럼 추가:
  - `modern_name` - 현대 한글명
  - `name_en` - 영문명
  - `aliases[]` - 동의어 배열
  - `category` - 분류
  - `nutrients` - 영양소 (JSONB)
  - `updated_at` - 수정일시

- `disease_master` 컬럼 추가:
  - `modern_name_ko` - 현대 한글명
  - `name_en` - 영문명
  - `icd10_code` - ICD-10 코드
  - `category` - 분류
  - `aliases[]` - 동의어 배열
  - `updated_at` - 수정일시

### [기능] 시드 데이터 생성
- `foods_master`: 70+ 식재료
  - 카테고리: 과일, 채소, 곡물, 약재, 해산물, 육류, 견과류
  - 동의보감 원문명 → 현대 한글명 → 영문명 매핑
  - 영양소 정보 (JSONB)

- `disease_master`: 55+ 증상/질환
  - 카테고리: 수면, 소화, 피로, 호흡, 순환, 피부, 정신, 통증, 비뇨, 여성, 면역
  - ICD-10 코드 매핑
  - 동의어 배열

---

## 적용사항

### [파일] 생성된 파일
| 파일 | 설명 | 크기 |
|------|------|------|
| `database/sql/08_extend_master_tables.sql` | 마이그레이션 (컬럼 추가/인덱스/트리거) | 3.8KB |
| `database/sql/09_foods_master_seed.sql` | 식재료 시드 데이터 | 11.2KB |
| `database/sql/10_disease_master_seed.sql` | 질환 시드 데이터 | 9.3KB |

### [파일] 수정된 파일
| 파일 | 변경 사항 |
|------|-----------|
| `docs/erd/schema.integrated.dbml` | `foods_master`, `disease_master` 컬럼 추가 |
| `docs/erd/readme.md` | 테이블 통계 40→45, 날짜 업데이트 |
| `docs/erd/erd-integrated.md` | TKM/PubMed 테이블 다이어그램 추가 |
| `docs/erd/erd-full.md` | 신규 테이블 반영 |
| `docs/erd/erd-content-rag-billing.md` | TKM/PubMed 섹션 추가 |
| `docs/erd/erd-health-stack.md` | 날짜 업데이트 |

---

## 오류
- 없음 (정상 수행)

---

## 결과물

### [산출물] SQL 실행 순서
```bash
# Supabase SQL Editor에서 순서대로 실행
1. 08_extend_master_tables.sql  # 컬럼 추가
2. 09_foods_master_seed.sql     # 식재료 데이터
3. 10_disease_master_seed.sql   # 질환 데이터
```

### [특징] UPSERT 방식
- 시드 데이터는 `ON CONFLICT DO UPDATE` 방식
- 기존 데이터 보존하면서 신규 컬럼만 업데이트 가능

---

## 회고

### [좋았던 점]
- 동의보감 원문(漢字) → 현대 한글 → 영문 3단계 매핑 체계 구축
- ICD-10 코드 연동으로 의료 표준과 연계 가능
- GIN 인덱스로 별칭 검색 최적화

### [아쉬운 점]
- 시드 데이터가 수동 작성 → 추후 AI/크롤링 기반 자동화 필요
- `tradition_foods` 32만건과의 자동 매핑 로직 미구현

---

## 다음 행동
- [ ] Supabase에 마이그레이션 실행
- [ ] `symptom_ingredient_map` 시드 데이터 생성 (증상-재료 관계)
- [ ] `traditional_foods` → 마스터 테이블 자동 매핑 스크립트
- [x] `tkm_symptom_master` 시드 데이터 생성 (완료: 11_tkm_symptom_master_seed.sql)
- [ ] `tkm_to_modern_map` 시드 데이터 생성

---

## 추가 작업 (22:27)

### [기능] TKM 증상 마스터 시드 데이터
- `tkm_symptom_master` 테이블에 `name_en` 컬럼 추가
- 시드 데이터 40+ 항목 생성
  - 카테고리: 수면, 소화, 피로, 호흡, 순환, 피부, 정신, 통증, 여성, 비뇨
  - `pattern_tags`: 한의학 패턴 (寒/熱/虛/實/痰/瘀血)
  - 동의보감 출처 정보 포함

### [파일] 생성
| 파일 | 설명 |
|------|------|
| `database/sql/11_tkm_symptom_master_seed.sql` | TKM 증상 테이블 생성 + 시드 데이터 |

---

## 추가 작업 (22:33)

### [기능] TKM → 현대질환 매핑 시드 데이터
- `tkm_to_modern_map` 테이블 생성 + 시드 데이터
- 매핑 40+ 항목 생성
  - `mapping_strength`: high/medium/low
  - `mapping_type`: equivalent/overlap/differential/context
  - 교차 매핑 포함 (한 TKM 증상 → 여러 현대 질환)
- 조회용 뷰 `v_tkm_to_modern_summary` 생성

### [파일] 생성
| 파일 | 설명 |
|------|------|
| `database/sql/12_tkm_to_modern_map_seed.sql` | TKM→현대질환 매핑 테이블 + 시드 |

---

## 추가 작업 (23:16)

### [기능] 증상 → 식재료 추천 매핑 시드 데이터
- `symptom_ingredient_map` 테이블 확장:
  - `direction`: recommend/good/neutral/caution/avoid
  - `priority`: 1-100 (높을수록 우선 표시)
  - `evidence_level`: traditional/clinical/empirical/theoretical
  - `source_ref`: 출처 (동의보감/현대연구 등)
- 시드 데이터 70+ 항목:
  - 불면 → 대추(추천), 상추(추천), 인삼(주의)
  - 소화불량 → 무(추천), 생강(추천), 우유(주의)
  - 피로 → 인삼(추천), 황기(추천), 닭고기(권장)
  - 기침 → 배(추천), 연근(권장), 꿀(권장)
  - 수족냉증 → 생강(추천), 계피(추천), 녹두(주의)
  - 등 12개 증상 매핑
- 조회용 뷰 `v_symptom_ingredient_recommendations` 생성

### [파일] 생성
| 파일 | 설명 |
|------|------|
| `database/sql/13_symptom_ingredient_map_seed.sql` | 증상→식재료 추천 매핑 + 시드 |

---

## 추가 작업 (23:20)

### [기능] 레시피 + 증상→레시피 매핑 시드 데이터
- `recipes` 테이블 확장:
  - `prep_time_min`, `cook_time_min`, `servings`, `difficulty`
  - `meal_type[]`, `nature`, `flavor[]`, `target_organs[]`
- 레시피 시드 데이터 23개:
  - 차류: 대추차, 생강차, 매실차, 국화차, 결명자차, 율무차, 오미자차 등
  - 죽류: 연자죽, 흑임자죽, 팥죽
  - 탕류: 삼계탕, 황기삼계탕
  - 반찬/기타: 상추겉절이, 무생채, 검정콩밥, 현미밥, 배숙
- `symptom_recipe_map` 확장:
  - `rationale_ko`: 추천 이유
  - `best_time`: 최적 섭취 시간
  - `frequency`: 권장 빈도 (daily/weekly/occasionally)
- 조회용 뷰 `v_symptom_recipe_recommendations` 생성

### [파일] 생성
| 파일 | 설명 |
|------|------|
| `database/sql/14_recipes_symptom_recipe_map_seed.sql` | 레시피 + 증상→레시피 매핑 |

---

## 추가 작업 (23:25)

### [기능] 골든 질문 30개 테스트 세트
- 검색/추천 품질 평가용 테스트 질문 문서화
- 카테고리별 분류:
  - A. 소화/장 (10개)
  - B. 수면/스트레스/두통/피로 (8개)
  - C. 면역/호흡기/알레르기/피부 (6개)
  - D. 대사/만성(혈압·혈당·지질) (6개)
- 각 질문별 핵심 키워드, 평가 포인트 정리
- 미지원 시나리오 식별 (약물 상호작용, 영양소 검색 등)

### [파일] 생성
| 파일 | 설명 |
|------|------|
| `docs/test/golden_questions_v1.md` | 골든 질문 30개 테스트 세트 |

---

## 추가 작업 (23:30)

### [기능] PubMed 검색 전략 시드 데이터
- `modern_to_mesh_map` 테이블 생성:
  - 50+ MeSH 용어 매핑
  - 불면→Sleep Initiation and Maintenance Disorders (D007319)
  - 소화불량→Dyspepsia (D004415)
  - 피로→Fatigue (D005221)
- `symptom_pubmed_map` 테이블 생성:
  - 30+ 영문 검색 키워드
  - primary/secondary/context 역할 구분
- `ingredient_pubmed_map` 테이블 생성:
  - 80+ 식재료 영문명/활성화합물 매핑
  - 주요 화합물: Ginsenoside, Allicin, Gingerol, Curcumin 등
  - 학명 + 일반명 + 화합물 3단계 검색 지원
- 조회용 뷰 `v_pubmed_search_terms` 생성

### [파일] 생성
| 파일 | 설명 |
|------|------|
| `database/sql/15_pubmed_search_seed.sql` | PubMed MeSH/키워드/화합물 시드 |

---

## 추가 작업 (23:40)

### [기능] Supabase 마이그레이션 형식 정리
- `supabase/migrations/` 폴더 생성
- 8개 SQL 파일을 타임스탬프 형식으로 복사:
  - `20260206220000_extend_master_tables.sql`
  - `20260206220100_foods_master_seed.sql`
  - `20260206220200_disease_master_seed.sql`
  - `20260206220300_tkm_symptom_master_seed.sql`
  - `20260206220400_tkm_to_modern_map_seed.sql`
  - `20260206220500_symptom_ingredient_map_seed.sql`
  - `20260206220600_recipes_symptom_recipe_map_seed.sql`
  - `20260206220700_pubmed_search_seed.sql`
- README.md 작성 (실행 방법 문서화)

### [파일] 생성
| 파일 | 설명 |
|------|------|
| `supabase/migrations/*.sql` | 마이그레이션 8개 파일 |
| `supabase/migrations/README.md` | 실행 가이드 |
| `supabase/config.toml` | 기본 설정 파일 |
