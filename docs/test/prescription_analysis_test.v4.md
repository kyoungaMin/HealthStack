# 처방전 분석 API 테스트 리포트 v4

**테스트 일시**: 2026-02-08 15:07  
**테스트 이미지**: `img/KakaoTalk_20260208_142809689.jpg`  
**테스트 환경**: Backend Python 3.x + FastAPI, Frontend Vite + React

---

## 1. 테스트 대상 처방전 정보

| 항목 | 실제 값 |
|------|---------|
| 환자명 | 윤용필 (남/만 56세) |
| 내방일 | 2026-01-24 |
| 조제일자 | 2026-01-31 |
| 병원 | 혜성정형외과의원 박준성 |
| 전화번호 | 032-715-4166 |

### 처방약 목록

| 약품명 | 분류 | 복용법 | 총 투약량 |
|--------|------|--------|-----------|
| 아세로낙정 (아세클로페낙) | 소염진통제 | 1일 2회 | 14정 |
| 넥세라정 20mg (에스오) | 소화성궤양용제 | 1일 1회 | 7정 |
| 휴티렌투엑스정 (애엽95%) | 위염치료제 | 1일 2회 | 14정 |
| 이트라펜세미정 | 진통제 | 1일 2회 | 14정 |
| 에페신정 | 근이완제 | 1일 2회 | 14정 |

**추정 질환**: 정형외과 처방 → **근골격계 통증** (관절염, 요통, 근육통 등)

---

## 2. API 테스트 결과

### 2.1 요청 정보
- **Endpoint**: `POST /api/analyze-with-image`
- **Symptom**: (빈 값 - 역추론 테스트)
- **User ID**: `test_user_v4`
- **응답 시간**: 26.88초
- **상태 코드**: ✅ 200 OK

### 2.2 응답 결과 분석

| 항목 | 결과 | 평가 |
|------|------|------|
| 증상 요약 | "...특정한 건강 상태를 추정하고 있어요" | ⚠️ 모호함 |
| 신뢰도 | `general` | ❌ 낮음 |
| 출처 | `ai_generated_openai` | ✅ AI fallback 동작 |
| 매칭된 증상 | "불명확한 건강 상태" | ❌ 역추론 실패 |
| 추천 식재료 | 3개 (신선한 야채, 가공식품 피하기, 정제 설탕 피하기) | ⚠️ 너무 일반적 |
| 추천 레시피 | 2개 (채소 스무디, 닭가슴살 샐러드) | ⚠️ 특정 증상 무관 |
| 약물 분석 | **0개** | ❌ OCR 약물 추출 실패 |
| 처방전 저장 | **0개** | ❌ DB 저장 실패 |

---

## 3. 발견된 문제점

### 🔴 Critical (심각)

#### 3.1 약물 추출 실패
- **현상**: OCR 텍스트에서 약물 이름이 추출되지 않음
- **원인**: `_extract_drug_names()` 함수가 한글 약품명 패턴을 인식하지 못함
- **영향**: 약물 정보 RAG 검색 불가, 증상 역추론 불가

#### 3.2 처방전 DB 저장 실패
- **현상**: `prescriptions.json`에 데이터가 저장되지 않음
- **원인**: `drug_names` 리스트가 비어있어 `save_prescription()` 조건 불충족
- **영향**: 사용자 히스토리 기능 무용지물

#### 3.3 병원명 추출 실패
- **현상**: "혜성정형외과의원"이 추출되지 않음
- **원인**: `NaverOCRService.extract_prescription_info()`의 병원명 추출 로직 미흡

### 🟡 Major (주요)

#### 3.4 증상 역추론 완전 실패
- **현상**: 소염진통제 + 근이완제 = 근골격계 통증으로 추론해야 하나, "불명확한 건강 상태"로 처리
- **원인**: 
  1. 약물 이름이 추출되지 않아 LLM에 전달 안 됨
  2. 프롬프트의 역추론 지시가 OCR 텍스트 기반으로 동작하지 않음
- **필요 조치**: OCR 원본 텍스트를 LLM에 직접 전달

#### 3.5 응답 시간 과다
- **현상**: 26.88초 소요
- **원인**: PubMed 검색 + Gemini/OpenAI API 호출 순차 실행
- **개선 방향**: 병렬 처리 또는 캐싱

### 🟢 Minor (경미)

#### 3.6 너무 일반적인 추천
- **현상**: "신선한 야채", "가공식품 피하기" 등 누구에게나 적용되는 조언
- **원인**: 증상 특정 실패로 일반 건강 조언으로 fallback

---

## 4. 개선 방안

### 4.1 당장 수정 필요 (Hot Fix)

| 우선순위 | 파일 | 수정 내용 |
|----------|------|-----------|
| P0 | `healthstack_api.py` | `drug_names`가 비어있어도 OCR full_text를 증상 분석에 활용 |
| P0 | `naver_ocr_service.py` | 한글 약품명 추출 패턴 강화 (`정`, `캡슐`, `밀리그램` 등) |
| P0 | `medication_service.py` | `save_prescription()` 조건 완화 (drugs 없어도 저장) |

### 4.2 단기 개선 (1주일 내)

```python
# naver_ocr_service.py 개선안
def _extract_drug_names_v2(self, texts: list[str]) -> list[str]:
    drug_patterns = [
        r".*정\s*\(",      # "아세로낙정("
        r".*캡슐",
        r".*밀리그램",
        r".*mg",
        r".*엑스정",
        r".*세미정",
    ]
    # 정규식 기반 추출
```

```python
# analyze_service.py 개선안
# 증상 추론 시 OCR raw text를 직접 포함
prompt = f"""
Input Data:
- OCR Raw Text: "{ocr_full_text}"
- Prescribed Meds: {current_meds}

TASK: Infer the patient's condition from the prescription.
"""
```

### 4.3 중기 개선 (1개월 내)

| 개선 영역 | 방안 |
|-----------|------|
| 약물 DB 구축 | 한국의약품안전관리원 API 연동 또는 약품명 사전 구축 |
| 병원 타입 추론 | "정형외과" → 근골격계, "내과" → 소화기/순환기 등 매핑 |
| 캐싱 | Redis 도입으로 반복 분석 속도 개선 |
| 비동기 처리 | PubMed/YouTube 검색 병렬화 |

---

## 5. 테스트 코드

```python
# test_prescription_api.py 실행 결과
============================================================
처방전 이미지 분석 API 테스트
============================================================

📤 요청 전송 중... (symptom: 빈 값, user_id: test_user_v4)

⏱️ 응답 시간: 26.88초
📊 상태 코드: 200

📋 분석 결과
========================================

🔍 증상 요약: ...특정한 건강 상태를 추정하고 있어요
📈 신뢰도: general
📂 출처: ai_generated_openai
🏷️ 매칭된 증상: 불명확한 건강 상태

🥬 추천 식재료: 3개
🍳 추천 레시피: 2개
💊 약물 분석: 0개  ← ❌ 문제점

처방전 저장 확인 테스트
========================================
저장된 처방전 수: 0  ← ❌ 문제점
```

---

## 6. 결론

### 현재 상태: ⚠️ 부분 동작

| 기능 | 상태 | 비고 |
|------|------|------|
| 이미지 업로드 | ✅ 정상 | - |
| OCR 텍스트 추출 | ✅ 정상 | Naver CLOVA OCR |
| 약물 이름 추출 | ❌ 실패 | 패턴 매칭 로직 부족 |
| 병원명 추출 | ❌ 실패 | 추출 로직 부재 |
| 증상 역추론 | ❌ 실패 | 약물 정보 없어서 추론 불가 |
| 식재료/레시피 추천 | ⚠️ 일반적 | 특정 증상 기반 아님 |
| 처방전 저장 | ❌ 실패 | 조건 불충족 |
| Guest ID 기능 | ✅ 정상 | user_id 전달 확인 |

### 다음 스프린트 목표
1. **약물 추출 로직 강화** (정규식 + 사전 기반)
2. **OCR 텍스트를 AI에 직접 전달** (역추론 강화)
3. **저장 조건 완화** (drugs 없어도 저장)
4. **병원명/병원 타입 추출** (진료과목 기반 증상 추론)

---

**작성자**: AI Assistant  
**버전**: v4  
**다음 테스트**: 약물 추출 로직 수정 후 재테스트
